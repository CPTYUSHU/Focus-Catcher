# 聊天 Web 应用使用指南

## 概述

这是一个完整的 AI 聊天 Web 应用，具有以下功能：
- 🤖 AI 助手对话（支持工具调用）
- 🔍 Web 搜索功能
- 📄 网页内容读取
- 💬 聊天历史管理
- 🎨 现代化深色主题 UI
- ⚡ 实时"思考中"动画

## 项目结构

```
fastapiapp/
├── frontend/           # 前端文件
│   ├── index.html     # 主 HTML 页面
│   ├── styles.css     # 样式表
│   └── app.js         # JavaScript 逻辑
├── main.py            # FastAPI 后端（提供 API 和静态文件服务）
└── docs/              # 文档
```

## 如何运行

### 1. 启动服务器

在项目根目录运行：

```bash
./start.sh
```

或者：

```bash
cd /Users/aiden/fastapiapp
./scripts/start_server.sh
```

### 2. 访问应用

打开浏览器访问：

```
http://127.0.0.1:8000
```

或

```
http://localhost:8000
```

### 3. 使用应用

1. **新建对话**：点击左侧面板的 "+ New Chat" 按钮
2. **发送消息**：在底部输入框输入问题，按 Enter 发送（Shift+Enter 换行）
3. **查看历史**：左侧面板显示所有聊天历史，点击可切换
4. **示例问题**：首次打开时可点击示例问题快速开始

## 功能特性

### AI 能力

- **智能对话**：使用 GPT-5 模型进行对话
- **Web 搜索**：自动搜索最新信息
- **网页阅读**：提取网页内容进行分析
- **多轮推理**：最多 5 轮工具调用迭代

### UI 特性

- **聊天历史**：自动保存到浏览器本地存储
- **思考动画**：等待响应时显示动态加载效果
- **工具标记**：显示 AI 使用了哪些工具
- **响应式设计**：适配桌面和移动设备
- **深色主题**：护眼的深色配色方案

## API 端点

### POST /chat

发送聊天消息并获取 AI 响应。

**请求体：**
```json
{
  "user_message": "你的问题"
}
```

**响应：**
```json
{
  "content": "AI 的回答",
  "tool_calls": [
    {
      "id": "call_xxx",
      "function": "web_search",
      "arguments": {"query": "搜索关键词"}
    }
  ]
}
```

### GET /api

健康检查端点，验证 API 是否运行。

### GET /

返回前端 HTML 页面。

## 技术栈

### 后端
- **FastAPI**：Web 框架
- **OpenAI SDK**：LLM 集成
- **BeautifulSoup**：HTML 解析
- **Requests**：HTTP 客户端

### 前端
- **原生 JavaScript**：无框架依赖
- **LocalStorage API**：聊天历史持久化
- **Fetch API**：后端通信
- **CSS3**：现代化样式和动画

## 常见问题

### Q: 为什么有时会返回"I encountered an issue processing the search results"？

**A: 已修复！** 这个问题是由于代码逻辑错误导致的：

**问题原因：**
- 当 LLM 调用工具时，`message.content` 可能为 `None`（这是正常的）
- 旧代码在没有工具调用时检查 `content`，如果为空就返回错误
- 但有时 LLM 在最后一轮仍返回空 `content`，导致错误触发

**修复方案：**
1. 改进了响应处理逻辑，区分三种情况：
   - 有工具调用 → 继续下一轮
   - 有内容 → 返回最终答案
   - 既无工具调用也无内容 → 重试，最后一轮才返回错误

2. 添加了更详细的日志，方便调试

### Q: 聊天历史保存在哪里？

**A:** 保存在浏览器的 LocalStorage 中，清除浏览器数据会丢失历史记录。

### Q: 如何清除聊天历史？

**A:** 目前需要手动清除浏览器的 LocalStorage：
1. 打开浏览器开发者工具（F12）
2. 进入 Application/Storage 标签
3. 找到 LocalStorage → http://127.0.0.1:8000
4. 删除 `chats` 键

### Q: 为什么有时响应很慢？

**A:** 可能的原因：
1. AI 正在进行多轮工具调用（最多 5 轮）
2. 网页读取时目标网站响应慢
3. 网络连接问题

### Q: 支持哪些问题类型？

**A:** 支持：
- ✅ 实时信息查询（天气、新闻、体育等）
- ✅ 需要搜索的问题
- ✅ 需要阅读特定网页的问题
- ✅ 一般知识问答

## 开发调试

### 查看后端日志

后端会在控制台输出详细日志：
- `[User]` - 用户输入
- `[Agent]` - AI 决策
- `[System]` - 工具执行结果
- `📋 COMPLETE MESSAGE HISTORY` - 完整消息历史

### 查看前端日志

打开浏览器开发者工具（F12）的 Console 标签查看前端日志。

### 修改代码后重启

```bash
# 停止服务器
lsof -t -i:8000 | xargs kill -9

# 重启服务器
./start.sh
```

## 未来改进

- [ ] 添加清除历史按钮
- [ ] 支持导出聊天记录
- [ ] 添加用户设置（主题、模型选择等）
- [ ] 支持文件上传
- [ ] 添加代码高亮显示
- [ ] 支持 Markdown 渲染
- [ ] 添加语音输入

## 故障排除

### 服务器无法启动

1. 检查端口 8000 是否被占用：
   ```bash
   lsof -i:8000
   ```

2. 检查环境变量是否设置：
   ```bash
   cat .env
   ```

3. 检查依赖是否安装：
   ```bash
   pip list | grep -E "fastapi|openai|beautifulsoup4"
   ```

### 前端无法连接后端

1. 确认服务器正在运行
2. 检查浏览器控制台是否有 CORS 错误
3. 确认访问的 URL 正确（http://127.0.0.1:8000）

### AI 响应异常

1. 检查 API Key 是否有效
2. 查看后端日志中的错误信息
3. 尝试重新提问或换一种表达方式

## 联系与支持

如有问题，请查看：
- 后端日志（终端输出）
- 前端日志（浏览器 Console）
- 其他文档：`docs/` 目录

---

**最后更新：** 2024-12-17
**版本：** 1.0.0

