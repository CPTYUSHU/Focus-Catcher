<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Catcher - æ•æ‰æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #10B981;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            background: #EF4444;
        }
        
        .response-time {
            display: inline-block;
            padding: 4px 12px;
            background: #3B82F6;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">ğŸ¯ Focus Catcher</h1>
            <p class="text-gray-400">æµ‹è¯•æ•æ‰ä½“éªŒ - ç›®æ ‡ï¼š< 200ms å“åº”</p>
        </div>

        <!-- Instructions -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-3">ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
                <li>åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­è¾“å…¥ä½ æƒ³"æ•æ‰"çš„æ–‡å­—ï¼ˆæ¨¡æ‹Ÿé€‰ä¸­æ–‡å­—ï¼‰</li>
                <li>ç‚¹å‡»"æ•æ‰"æŒ‰é’®æˆ–æŒ‰ <kbd class="px-2 py-1 bg-gray-700 rounded">Cmd+Enter</kbd></li>
                <li>è§‚å¯Ÿå“åº”æ—¶é—´æ˜¯å¦è¶³å¤Ÿå¿«ï¼ˆç›®æ ‡ < 200msï¼‰</li>
                <li>ä½“éªŒæ˜¯å¦"ä¸æ»‘"ã€"é›¶æ‰“æ–­"</li>
            </ol>
        </div>

        <!-- Capture Form -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">âœ¨ æ•æ‰åŒºåŸŸ</h2>
            
            <div class="space-y-4">
                <!-- Selected Text -->
                <div>
                    <label class="block text-sm font-medium mb-2">é€‰ä¸­çš„æ–‡å­—</label>
                    <textarea 
                        id="selectedText" 
                        class="w-full bg-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        rows="4"
                        placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³æ•æ‰çš„æ–‡å­—..."
                    ></textarea>
                </div>

                <!-- Page URL (auto-filled) -->
                <div>
                    <label class="block text-sm font-medium mb-2">é¡µé¢ URLï¼ˆè‡ªåŠ¨å¡«å……ï¼‰</label>
                    <input 
                        type="text" 
                        id="pageUrl" 
                        class="w-full bg-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        readonly
                    />
                </div>

                <!-- Page Title (auto-filled) -->
                <div>
                    <label class="block text-sm font-medium mb-2">é¡µé¢æ ‡é¢˜ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰</label>
                    <input 
                        type="text" 
                        id="pageTitle" 
                        class="w-full bg-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        readonly
                    />
                </div>

                <!-- Capture Button -->
                <button 
                    id="captureBtn"
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105"
                >
                    ğŸ¯ æ•æ‰ (Cmd+Enter)
                </button>

                <!-- Stats -->
                <div id="stats" class="grid grid-cols-3 gap-4 mt-4">
                    <div class="bg-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-blue-400" id="captureCount">0</div>
                        <div class="text-xs text-gray-400">æ€»æ•æ‰æ•°</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-400" id="avgResponseTime">-</div>
                        <div class="text-xs text-gray-400">å¹³å‡å“åº”æ—¶é—´</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-purple-400" id="currentSession">-</div>
                        <div class="text-xs text-gray-400">å½“å‰ä¼šè¯</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capture History -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">ğŸ“ æ•æ‰å†å²</h2>
                <button 
                    id="analyzeBtn"
                    class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 text-sm"
                    style="display: none;"
                >
                    ğŸ¤– AI åˆ†æå½“å‰ä¼šè¯
                </button>
            </div>
            <div id="captureHistory" class="space-y-3">
                <p class="text-gray-400 text-center py-8">è¿˜æ²¡æœ‰æ•æ‰è®°å½•</p>
            </div>
        </div>

        <!-- AI Analysis Result -->
        <div id="analysisResult" class="bg-gray-800 rounded-lg p-6 mt-6" style="display: none;">
            <h2 class="text-xl font-bold mb-4">ğŸ¤– AI åˆ†æç»“æœ</h2>
            <div id="analysisContent" class="prose prose-invert max-w-none">
                <!-- Analysis will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Auto-fill page info
        document.getElementById('pageUrl').value = window.location.href;
        document.getElementById('pageTitle').value = document.title;

        // Stats
        let captureCount = 0;
        let responseTimes = [];
        let currentSessionId = null;
        let allSessions = [];
        let allCaptures = [];

        // Capture function
        async function capture() {
            const selectedText = document.getElementById('selectedText').value.trim();
            
            if (!selectedText) {
                showToast('è¯·è¾“å…¥è¦æ•æ‰çš„æ–‡å­—', 'error');
                return;
            }

            const captureBtn = document.getElementById('captureBtn');
            captureBtn.disabled = true;
            captureBtn.textContent = 'â³ æ•æ‰ä¸­...';

            const startTime = Date.now();

            try {
                const response = await fetch('http://127.0.0.1:8000/api/focus/capture', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selected_text: selectedText,
                        page_url: document.getElementById('pageUrl').value,
                        page_title: document.getElementById('pageTitle').value
                    })
                });

                const responseTime = Date.now() - startTime;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // Update stats
                responseTimes.push(responseTime);
                currentSessionId = data.session_id;

                updateStats();
                
                showToast(`âœ… æ•æ‰æˆåŠŸï¼å“åº”æ—¶é—´: ${responseTime}ms`, 'success');

                // Reload history to show the new capture
                loadAllHistory();

                // Clear input
                document.getElementById('selectedText').value = '';
                document.getElementById('selectedText').focus();

            } catch (error) {
                showToast(`âŒ æ•æ‰å¤±è´¥: ${error.message}`, 'error');
            } finally {
                captureBtn.disabled = false;
                captureBtn.textContent = 'ğŸ¯ æ•æ‰ (Cmd+Enter)';
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('captureCount').textContent = captureCount;
            
            const avgTime = responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length;
            document.getElementById('avgResponseTime').textContent = `${avgTime.toFixed(0)}ms`;
            
            document.getElementById('currentSession').textContent = currentSessionId || '-';
        }


        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // AI Analysis function for specific session
        async function analyzeSpecificSession(sessionId) {
            try {
                showToast('ğŸ¤– æ­£åœ¨åˆ†æä¼šè¯ #' + sessionId + '...', 'info');
                
                const response = await fetch(`http://127.0.0.1:8000/api/focus/analyze/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // Show analysis result
                const analysisResult = document.getElementById('analysisResult');
                const analysisContent = document.getElementById('analysisContent');
                
                // Display as plain text with preserved formatting
                // Use textContent to avoid HTML injection and preserve line breaks with CSS
                analysisContent.textContent = data.learning_guide;
                analysisContent.style.whiteSpace = 'pre-wrap';
                analysisResult.style.display = 'block';

                // Scroll to analysis
                analysisResult.scrollIntoView({ behavior: 'smooth', block: 'start' });

                showToast('âœ… AI åˆ†æå®Œæˆï¼', 'success');

            } catch (error) {
                showToast(`âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // AI Analysis function (for current session button)
        async function analyzeSession() {
            if (!currentSessionId) {
                showToast('æ²¡æœ‰æ´»è·ƒçš„ä¼šè¯å¯ä»¥åˆ†æ', 'error');
                return;
            }
            
            await analyzeSpecificSession(currentSessionId);
        }

        // Delete session function
        async function deleteSession(sessionId) {
            // Confirm before deletion
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯ #${sessionId} åŠå…¶æ‰€æœ‰æ•æ‰è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                showToast('ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤ä¼šè¯ #' + sessionId + '...', 'info');
                
                const response = await fetch(`http://127.0.0.1:8000/api/focus/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                showToast('âœ… ' + data.message, 'success');
                
                // Reload history to reflect changes
                await loadAllHistory();
                
                // If deleted session was the current session, clear current session
                if (sessionId === currentSessionId) {
                    currentSessionId = null;
                    document.getElementById('currentSession').textContent = '-';
                }

            } catch (error) {
                showToast(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // Event listeners
        document.getElementById('captureBtn').addEventListener('click', capture);
        document.getElementById('analyzeBtn').addEventListener('click', analyzeSession);

        document.getElementById('selectedText').addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                capture();
            }
        });

        // Load all history on page load
        async function loadAllHistory() {
            try {
                // Get all sessions
                const sessionsResponse = await fetch('http://127.0.0.1:8000/api/focus/sessions');
                const sessionsData = await sessionsResponse.json();
                allSessions = sessionsData.sessions;

                // Get captures for all sessions
                const historyContainer = document.getElementById('captureHistory');
                historyContainer.innerHTML = '';

                if (allSessions.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-400 text-center py-8">è¿˜æ²¡æœ‰æ•æ‰è®°å½•</p>';
                    return;
                }

                // Load captures for each session
                for (const session of allSessions) {
                    const capturesResponse = await fetch(`http://127.0.0.1:8000/api/focus/captures/${session.id}`);
                    const capturesData = await capturesResponse.json();
                    
                    if (capturesData.captures.length > 0) {
                        // Add session header
                        const sessionHeader = document.createElement('div');
                        sessionHeader.className = 'mb-4 mt-6 first:mt-0';
                        // Session title with analyze button
                        const sessionTitleDiv = document.createElement('div');
                        sessionTitleDiv.className = 'flex items-center justify-between mb-3';
                        
                        sessionTitleDiv.innerHTML = `
                            <div class="flex items-center gap-3 flex-1">
                                <div class="h-px flex-1 bg-gray-700"></div>
                                <div class="text-sm text-gray-400">
                                    ğŸ“š ä¼šè¯ #${session.id} 
                                    <span class="text-xs">(${capturesData.captures.length} æ¡æ•æ‰)</span>
                                </div>
                                <div class="h-px flex-1 bg-gray-700"></div>
                            </div>
                        `;
                        
                        // Add button container
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'flex items-center gap-2';
                        
                        // Add analyze button if session has >= 5 captures
                        if (capturesData.captures.length >= 5) {
                            const analyzeBtn = document.createElement('button');
                            analyzeBtn.className = 'bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 text-xs whitespace-nowrap';
                            analyzeBtn.textContent = 'ğŸ¤– AI åˆ†æ';
                            analyzeBtn.onclick = () => analyzeSpecificSession(session.id);
                            buttonContainer.appendChild(analyzeBtn);
                        }
                        
                        // Add delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg transition-all duration-200 text-xs whitespace-nowrap';
                        deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
                        deleteBtn.onclick = () => deleteSession(session.id);
                        buttonContainer.appendChild(deleteBtn);
                        
                        sessionTitleDiv.appendChild(buttonContainer);
                        sessionHeader.appendChild(sessionTitleDiv);
                        historyContainer.appendChild(sessionHeader);

                        // Add captures for this session (reverse to show newest first)
                        capturesData.captures.reverse().forEach(capture => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'bg-gray-700 rounded-lg p-4 mb-3';
                            
                            const captureTime = new Date(capture.timestamp);
                            const timeStr = captureTime.toLocaleString('zh-CN', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            historyItem.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-sm text-gray-400">#${capture.id}</span>
                                    <span class="text-xs text-gray-500">${timeStr}</span>
                                </div>
                                <p class="text-white text-sm leading-relaxed">${capture.selected_text.substring(0, 150)}${capture.selected_text.length > 150 ? '...' : ''}</p>
                                ${capture.page_title ? `<div class="text-xs text-gray-500 mt-2">ğŸ“„ ${capture.page_title}</div>` : ''}
                            `;

                            historyContainer.appendChild(historyItem);
                        });
                    }
                }

                // Update stats
                const totalCaptures = allSessions.reduce((sum, s) => sum + s.capture_count, 0);
                captureCount = totalCaptures;
                document.getElementById('captureCount').textContent = totalCaptures;

                // Set current session
                if (allSessions.length > 0 && allSessions[0].status === 'active') {
                    currentSessionId = allSessions[0].id;
                    document.getElementById('currentSession').textContent = currentSessionId;
                    
                    // Show analyze button if session has >= 5 captures
                    if (allSessions[0].capture_count >= 5) {
                        document.getElementById('analyzeBtn').style.display = 'block';
                    }
                }

            } catch (error) {
                console.error('Failed to load history:', error);
                const historyContainer = document.getElementById('captureHistory');
                historyContainer.innerHTML = '<p class="text-red-400 text-center py-8">åŠ è½½å†å²è®°å½•å¤±è´¥</p>';
            }
        }

        // Initialize on page load
        loadAllHistory();

        // Focus on text area
        document.getElementById('selectedText').focus();
    </script>
</body>
</html>

